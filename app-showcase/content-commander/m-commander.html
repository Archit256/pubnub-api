<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Content Commander </title>
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
        <style>
          .youtube_img {
              width: 275px;
          }
        </style>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js">
        </script>
        <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js">
        </script>
    </head>
    <body>
      <div data-role="page" id="main">
        <div data-theme="a" data-role="header">
          <h3>
            Content Commander
          </h3>
        </div><!-- /header -->
        <div data-role="content" id="viewer_box" class="box left">
          <div id="content"></div>
        </div><!-- /content #viewer_box" -->

        <div data-role="content">
          <div data-role="collapsible-set" data-theme="a" data-content-theme="">
            <div data-role="collapsible" data-collapsed="true" >
              <h3>
                YouTube
              </h3>
              <div data-role="fieldcontain" id="youtube_box">
                <fieldset data-role="controlgroup">
                  <label for="search_query">
                    Search
                  </label>
                  <input id="search_query" placeholder="" value="" type="text" />
                  <input id="search_submit" type="button" value="Search" data-inline="true" />
                </fieldset>
              </div><!-- /fieldcontain -->
            </div><!-- /collapsible -->
          </div><!-- /collapsible-set -->
        </div><!-- /content -->
      </div><!-- /page #main -->


        <div data-role="page" id="popup">
          <div data-role="header" data-theme="a">
            <h1>Confirm Push</h1>
          </div><!-- /header -->

          <div data-role="content" data-theme="a">	
            <p>Do you really want to push the following video to your followers?</p>		
            <p id="youtube_confirm">
            <p>
            <p>
              <a href="#main" data-rel="back" data-role="button" data-inline="true" data-icon="delete" id="push_no">No</a>
              <a href="#main" data-role="button" data-inline="true" data-icon="arrow-r" id="push_yes">Yes</a>
            </p>	
          </div><!-- /content -->
        </div><!-- /page popup -->
    
      <!-- PUBNUB -->

      <div pub-key="pub-550ff6a3-aa50-466c-a2c7-55a6c3fa3345" sub-key="sub-f3307e99-6a4a-11e1-870f-affeca838b29" ssl="off" origin="pubsub.pubnub.com" id="pubnub"></div>
      <div style="display:none" id="uuid"></div>
      <script src="http://cdn.pubnub.com/pubnub-3.1.min.js"></script>
      <script>(function(){
        PUBNUB.subscribe({
          channel    : "content_commander", 
          restore    : false,      
          callback   : function(message) {
            if (message.name) {
              PUBNUB.events.fire(message.name, message.data);
            }
          },
          disconnect : function() { 
            console.log("Connection Lost.");
          },
          reconnect  : function() { 
            console.log("And we're Back!");
          }
        });

        var channel = "content_commander_" + $("#uuid").text(); 
        PUBNUB.subscribe({
          channel    : channel, 
          restore    : false,      
          callback   : function(message) {
            if (message.name) {
              PUBNUB.events.fire(message.name, message);
            }
          },
          disconnect : function() { 
            console.log("Connection Lost.");
          },
          reconnect  : function() { 
            console.log("And we're Back!");
          }
        });
      })();</script>

      <script>
        function newYoutubeDiv(video_id, title) {
          return "<div class='youtube_div' id='" + video_id + "'><div class='youtube_body'><h4>" + title + "</h4><img src='http://img.youtube.com/vi/" + video_id + "/0.jpg' class='youtube_img' /></div><a href='#popup' class='youtube_button' data-role='button' data-rel='dialog' data-transition='pop'>Push</a></div><hr/> ";
        }

        $("#search_submit").bind('click', function(e, ui) {
          e.preventDefault();

          var query = $("#search_query").val();
          if ((query == undefined) || (query.length == 0)) { return; }

          console.log('publishing');
          PUBNUB.publish({ 
            channel : "content_commander", 
            message : {
              "name"   : "search",
              "uuid"   : $("#uuid").text(),
              "data"   : {
                "query"   : query
              }
            }
          });
        });

        PUBNUB.events.bind("youtube_results", function(message) {
          for (var i=0; i < message.data.video_ids.length; i++) {
            $("#youtube_box").append(newYoutubeDiv(message.data.video_ids[i][0], 
                                                   message.data.video_ids[i][1]));
          }  
          $(".youtube_button")
            .button()
            .bind('click', function(e) {
              $("#youtube_confirm").append($(this).parent().children('.youtube_body').html());
              $(document).data('selected_video', $(this).parent().attr('id'));
            });
        });

        $("#push_yes").bind('click', function(e) {
          console.log('pushing!');
          PUBNUB.publish({ 
            channel : "content_commander", 
            message : {
              "name"   : "youtube_link",
              "data"   : {
                "video_id" : $(document).data('selected_video')
              }
            }
          });
        });

      </script>
      <script src="js/youtube.js"></script>
    </body>
</html>
