(function(){function H(a){if(!a)return[[0,0]];var b=[];if(a.touches&&a.touches[0])f.each(a.touches,function(e){b.push([e.pageX,e.pageY])});else if(a.pageX)b.push([a.pageX,a.pageY]);else try{b.push([a.clientX+body.scrollLeft+doc.scrollLeft,a.clientY+body.scrollTop+doc.scrollTop])}catch(c){}return b}function t(a,b){var c=0;for(b=b||"Top";a;){c+=a["offset"+b];a=a.offsetParent}return c}function g(a){function b(){if(c.uuid&&c.joined){u.add(c);a(c)}}var c={uuid:f.uuid(function(e){c.uuid=e;b()}),joined:f.time(function(e){c.joined=
e;b()})}}function v(a){a.intervals={animate:0,move:{}};a.cell.size=Math.floor(a.image.width/a.cell.count);a.node=f.create("div");a.opacity=a.opacity||1;j(a.node,{opacity:a.opacity,position:"absolute",top:a.top,left:a.left,width:a.cell.size,height:a.image.height,backgroundRepeat:"no-repeat"});n(a,0);w.appendChild(a.node);return a}function n(a,b,c){c=c||{};if(typeof c.top=="number")a.image.offset.top=c.top;if(typeof c.left=="number")a.image.offset.left=c.left;j(a.node,{backgroundPosition:"-"+(a.cell.size*
b+a.image.offset.left)+"px -"+a.image.offset.top+"px"})}function o(a,b,c,e,d){if(!d){d=0;x(a)}if(d===b.length)if(c===0)return e&&e();else{c--;d=0}var h=b[d][0]||b[d];a.intervals.animate=setTimeout(function(){n(a,h);o(a,b,c,e,d+1)},(b[d][1]||0.1)*1E3)}function y(a,b,c,e,d){if(!d){d=0;l(a)}if(d===b.length)if(c===0)return e&&e();else{c--;d=0}if(b[d][2])o(a,b[d][2],b[d][3]||0);z(a,b[d][0],b[d][1],function(){y(a,b,c,e,d+1)})}function z(a,b,c,e){var d=+new Date;l(a);k(b,function(h,p){var m=d,A=d+c,B=a[h]||
0,I=p-B,C={},q=h+p;D(a,q);a.intervals.move[q]=setInterval(function(){m=+new Date;a[h]=A<=m?p:I*(m-d)/c+B;C[h]=a[h];j(a.node,C);if(A<=m&&a.intervals.move){l(a,q);e&&e()}},Math.ceil(1E3/a.framerate))})}function l(a){clearTimeout(a.intervals.animate);k(a.intervals.move,function(b){clearInterval(a.intervals.move[b])})}function D(a,b){clearInterval(a.intervals.move[b])}function x(a){clearTimeout(a.intervals.animate)}function J(a){a=g.pointers=H(a);var b=t(r,"Top"),c=t(r,"Left");k(a,function(e){e[0]-=c+
10;e[1]-=b+40});E({pointers:g.pointers,uuid:"",now:+new Date});K();return false}function E(a){var b=a.uuid||"self",c=a.last;a=a.pointers;var e=0;if(g.info)if(b!=g.info.uuid){i[b]||(i[b]={last:c,touches:[]});k(a,function(d){if(!i[b].touches[e]){i[b].touches[e]={xy:d,sprite:s.create({image:{url:"",width:20,height:7,offset:{top:0,left:0}},cell:{count:1},left:d[0],top:d[1],framerate:60})};j(i[b].touches[e].sprite.node,{backgroundColor:"#"+(b=="self"?g.info.uuid||"f0f":b).slice(-3)})}b=="self"?j(i[b].touches[e].sprite.node,
{left:d[0],top:d[1]}):s.move(i[b].touches[e].sprite,{left:d[0],top:d[1]},F);e++})}}function L(){f.subscribe({channel:G},function(a){switch(a.action){case "player_state":E(a);break}})}var f=PUBNUB,u=function(){var a={};return{add:function(b){return a[b.uuid]=b},get:function(b){return a[b]},all:function(){return a}}}(),M=f.bind,k=f.each,w=f.search("body")[0],N=f.$,j=f.css,s={painter:function(a){w=a},create:v,setframe:n,animate:o,move:z,movie:y,stop_all:l,stop_move:D,stop_animate:x},O={players:u,current_player:g};
v=f.create;var P=f.publish,i={},r=N("painter"),G="pubnub-multi-touch",F=100,Q=0;s.painter(r);g={ready:0};O.current_player(function(a){g.info=a;g.ready=1;L()});var K=function(a,b){var c,e=0,d=function(){if(e+b>+new Date){clearTimeout(c);c=setTimeout(d,b)}else{e=+new Date;a()}};return d}(function(){if(g.ready){var a={action:"player_state",pointers:g.pointers,uuid:g.info.uuid,last:Q++};P({channel:G,message:a})}},F);k("mousedown,mousemove,touchmove,touchstart,touchend,selectstart".split(","),function(a){M(a,
document,J)})})();
